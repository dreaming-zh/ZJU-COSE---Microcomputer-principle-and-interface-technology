C51 COMPILER V9.57.0.0   NTC                                                               06/05/2022 12:44:33 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE NTC
OBJECT MODULE PLACED IN .\Objects\NTC.obj
COMPILER INVOKED BY: F:\Keil\C51\BIN\C51.EXE NTC.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\NTC.lst)
                    - TABS(2) OBJECT(.\Objects\NTC.obj)

line level    source

   1          
   2          /*---------------------------------------------------------------------*/
   3          /* --- STC MCU Limited ------------------------------------------------*/
   4          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
   5          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   6          /* --- Fax: 86-0513-55012956,55012947,55012969 -----------------------*/
   7          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
   8          /* --- Web: www.STCMCU.com --------------------------------------------*/
   9          /* --- Web: www.GXWMCU.com --------------------------------------------*/
  10          /* --- QQ:  800003751 -------------------------------------------------*/
  11          /* 如果要在程序中使用此代码,请在程序中注明使用了STC的资料及程序        */
  12          /*---------------------------------------------------------------------*/
  13          /*************  本程序功能说明  **************
  14          左边4位数码管显示第9通道片内BGV的基准电压读数, 
  15          右边4位数码管显示NTC温度值, 分辨率0.1度.
  16          NTC使用1%精度的MF52 B：3950，10K@25度C.
  17          测温度时, 为了通用, 使用12位的AD，测温度的ADC3进行4次ADC连续采样 
  18          使用对分查找表格来计算, 小数点后一位数是用线性插补来计算的.
  19          ******************************************/
  20          #include <stc15.h>
  21          #include <intrins.h>
  22          #include "gdef.h"
  23          #include "adc.h"
  24          
  25          /********************** ADC初始化 ************************/
  26          void ADC_Init()  //CLK_DIV的ADRJ默认为0
  27          { 
  28   1          ADC_CONTR = 0xE0;   //90T, ADC power on
  29   1        P1ASF = 0;
  30   1      //  delay();          //1ms以内电源就能稳定
  31   1      }   
  32          
  33          /*******************查询法读一次ADC结果*******************/
  34          u16 Get_ADC10bitResult(u8 channel)  //channel = 0~8,8为内部BGV
  35          {
  36   1        ADC_RES = 0;
  37   1          ADC_RESL = 0;
  38   1      
  39   1          ADC_CONTR = (ADC_CONTR & 0xe0) | 0x08 | (channel&7);    //start the ADC
  40   1      
  41   1          while((ADC_CONTR & 0x10) == 0)  ;   //wait for ADC finish
  42   1          ADC_CONTR &= ~0x10;         //清除ADC结束标志
  43   1          return  (((u16)ADC_RES << 2) | (ADC_RESL & 3));   
  44   1      }
  45          
  46          
  47          //  MF52E 10K at 25, B = 3950, ADC = 12 bits
  48          u16 code temp_table[]={
  49                  140,    //;-40  0
  50                  149,    //;-39  1
  51                  159,    //;-38  2
  52                  168,    //;-37  3
  53                  178,    //;-36  4
  54                  188,    //;-35  5
C51 COMPILER V9.57.0.0   NTC                                                               06/05/2022 12:44:33 PAGE 2   

  55                  199,    //;-34  6
  56                  210,    //;-33  7
  57                  222,    //;-32  8
  58                  233,    //;-31  9
  59                  246,    //;-30  10
  60                  259,    //;-29  11
  61                  272,    //;-28  12
  62                  286,    //;-27  13
  63                  301,    //;-26  14
  64                  317,    //;-25  15
  65                  333,    //;-24  16
  66                  349,    //;-23  17
  67                  367,    //;-22  18
  68                  385,    //;-21  19
  69                  403,    //;-20  20
  70                  423,    //;-19  21
  71                  443,    //;-18  22
  72                  464,    //;-17  23
  73                  486,    //;-16  24
  74                  509,    //;-15  25
  75                  533,    //;-14  26
  76                  558,    //;-13  27
  77                  583,    //;-12  28
  78                  610,    //;-11  29
  79                  638,    //;-10  30
  80                  667,    //;-9   31
  81                  696,    //;-8   32
  82                  727,    //;-7   33
  83                  758,    //;-6   34
  84                  791,    //;-5   35
  85                  824,    //;-4   36
  86                  858,    //;-3   37
  87                  893,    //;-2   38
  88                  929,    //;-1   39
  89                  965,    //;0    40
  90                  1003,   //;1    41
  91                  1041,   //;2    42
  92                  1080,   //;3    43
  93                  1119,   //;4    44
  94                  1160,   //;5    45
  95                  1201,   //;6    46
  96                  1243,   //;7    47
  97                  1285,   //;8    48
  98                  1328,   //;9    49
  99                  1371,   //;10   50
 100                  1414,   //;11   51
 101                  1459,   //;12   52
 102                  1503,   //;13   53
 103                  1548,   //;14   54
 104                  1593,   //;15   55
 105                  1638,   //;16   56
 106                  1684,   //;17   57
 107                  1730,   //;18   58
 108                  1775,   //;19   59
 109                  1821,   //;20   60
 110                  1867,   //;21   61
 111                  1912,   //;22   62
 112                  1958,   //;23   63
 113                  2003,   //;24   64
 114                  2048,   //;25   65
 115                  2093,   //;26   66
 116                  2137,   //;27   67
C51 COMPILER V9.57.0.0   NTC                                                               06/05/2022 12:44:33 PAGE 3   

 117                  2182,   //;28   68
 118                  2225,   //;29   69
 119                  2269,   //;30   70
 120                  2312,   //;31   71
 121                  2354,   //;32   72
 122                  2397,   //;33   73
 123                  2438,   //;34   74
 124                  2479,   //;35   75
 125                  2519,   //;36   76
 126                  2559,   //;37   77
 127                  2598,   //;38   78
 128                  2637,   //;39   79
 129                  2675,   //;40   80
 130                  2712,   //;41   81
 131                  2748,   //;42   82
 132                  2784,   //;43   83
 133                  2819,   //;44   84
 134                  2853,   //;45   85
 135                  2887,   //;46   86
 136                  2920,   //;47   87
 137                  2952,   //;48   88
 138                  2984,   //;49   89
 139                  3014,   //;50   90
 140                  3044,   //;51   91
 141                  3073,   //;52   92
 142                  3102,   //;53   93
 143                  3130,   //;54   94
 144                  3157,   //;55   95
 145                  3183,   //;56   96
 146                  3209,   //;57   97
 147                  3234,   //;58   98
 148                  3259,   //;59   99
 149                  3283,   //;60   100
 150                  3306,   //;61   101
 151                  3328,   //;62   102
 152                  3351,   //;63   103
 153                  3372,   //;64   104
 154                  3393,   //;65   105
 155                  3413,   //;66   106
 156                  3432,   //;67   107
 157                  3452,   //;68   108
 158                  3470,   //;69   109
 159                  3488,   //;70   110
 160                  3506,   //;71   111
 161                  3523,   //;72   112
 162                  3539,   //;73   113
 163                  3555,   //;74   114
 164                  3571,   //;75   115
 165                  3586,   //;76   116
 166                  3601,   //;77   117
 167                  3615,   //;78   118
 168                  3628,   //;79   119
 169                  3642,   //;80   120
 170                  3655,   //;81   121
 171                  3667,   //;82   122
 172                  3679,   //;83   123
 173                  3691,   //;84   124
 174                  3702,   //;85   125
 175                  3714,   //;86   126
 176                  3724,   //;87   127
 177                  3735,   //;88   128
 178                  3745,   //;89   129
C51 COMPILER V9.57.0.0   NTC                                                               06/05/2022 12:44:33 PAGE 4   

 179                  3754,   //;90   130
 180                  3764,   //;91   131
 181                  3773,   //;92   132
 182                  3782,   //;93   133
 183                  3791,   //;94   134
 184                  3799,   //;95   135
 185                  3807,   //;96   136
 186                  3815,   //;97   137
 187                  3822,   //;98   138
 188                  3830,   //;99   139
 189                  3837,   //;100  140
 190                  3844,   //;101  141
 191                  3850,   //;102  142
 192                  3857,   //;103  143
 193                  3863,   //;104  144
 194                  3869,   //;105  145
 195                  3875,   //;106  146
 196                  3881,   //;107  147
 197                  3887,   //;108  148
 198                  3892,   //;109  149
 199                  3897,   //;110  150
 200                  3902,   //;111  151
 201                  3907,   //;112  152
 202                  3912,   //;113  153
 203                  3917,   //;114  154
 204                  3921,   //;115  155
 205                  3926,   //;116  156
 206                  3930,   //;117  157
 207                  3934,   //;118  158
 208                  3938,   //;119  159
 209                  3942    //;120  160
 210          };
 211          
 212          /********************  计算温度 ***********************************************/
 213          // 计算结果: 0对应-40.0度, 400对应0度, 650对应25.0度, 最大1600对应120.0度. 
 214          // 为了通用, ADC输入为12bit的ADC值.
 215          /**********************************************/  
 216          #define     D_SCALE     10      //1位小数，为了避免出现小数，结果放大倍数
 217          u16 get_temperature(u16 adc)
 218          {
 219   1          u16 code *p;
 220   1          u8  j,k,min,max;
 221   1          
 222   1          adc = 4096 - adc;   //Rt接地
 223   1          p = temp_table;
 224   1          if(adc < p[0]||adc > p[160]) //超出量程   
 225   1          return (0xffff);
 226   1          
 227   1          min = 0;        //-40度
 228   1          max = 160;      //120度
 229   1      
 230   1          for(j=0; j<8; j++)  //对分查表，2^8可查256项>160
 231   1          {
 232   2              k = (min + max) / 2;
 233   2              if(adc < p[k]) max = k;
 234   2              else           min = k;
 235   2          }
 236   1          if(adc == p[min]) return min * D_SCALE;
 237   1      //    else if(adc == p[max]) return max * D_SCALE;
 238   1          else // min < temp < max   max=min+1  
 239   1          return min* D_SCALE+(adc - p[min]) * D_SCALE / (p[max] - p[min]);
 240   1      }
C51 COMPILER V9.57.0.0   NTC                                                               06/05/2022 12:44:33 PAGE 5   

 241          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    312    ----
   CONSTANT SIZE    =    322    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
